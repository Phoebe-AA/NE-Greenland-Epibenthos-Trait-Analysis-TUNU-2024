---
title: "NE Greenland Trait Analysis: Setting the model in HMSC"
author: "Phoebe Armitage"
date: '2023-June'
output:
 html_document:
  toc: TRUE
  anchor_sections: TRUE
  code_download: TRUE 
  code_folding: "hide"
  fig_caption: TRUE
  theme:
    bootswatch: "flatly"
  bibliography: references.bib
  link-citations: TRUE
editor_options: 
  markdown: 
    wrap: 72
---

```{r include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.show = "hide", results = "hide", eval = FALSE)
# to cite specific packages
knitr::write_bib(c("base", "bookdown", "rmarkdown"), "packages.bib")
```
## Load libraries 
```{r}
library(Hmsc); library(corrplot); library(vioplot); library(colorspace); library(parallel)
```
## Load data 
```{r}
load(file = "allData_A.R")
localDir = "."
#data.directory = file.path(localDir, "data")
model.directory = file.path(localDir, "models")
```
## Look at raw data 
```{r}
set.seed (1)
range(colMeans(Y>0))
hist(colMeans(Y>0), main = "prevalence")
hist(log(Y[Y>0]), main = "log abundance conditional on presence")
hist(rowSums(Y>0))
#Species richness across samples. 
names(X)
#Explore the correlations between the variables. 
plot(X)
```

## The HMSC model
First we need to set up all the parameters and syntax.
### Environmental covariates (fixed effects)
XFormula is for the environmental input you want for the model so here we need to define which environmental covariates we want. 
```{r}
XFormula <- ~ Depth + B.Temp + B.PSU + Oxygen + Turbidity  + Flourescence
```
### Traits 
TrFormula is the traits you want included in the model 
```{r}
TrFormula <- ~ Small + Small_med + Medium_S + Med_large + Large +
Globulose + Vermiform + Dorso_com + Later_com +  Upright +
  Calcareous + Siliceous + Chitinous + Cuticle + None_SK + 
  Asexual + Sexual_ext + Sexual_int + Sexual_brood + Pel_Plankto +
  Pel_Leci + Benthic_Dir + Sessile + Burrower + Crawler +
  Swimmer+ none_MV + Low + medium_MV + High +
  Deposit + Filter_Sus + Op_Sc + Pred + Arctic +
  Boreal + Cosmo
```
### Study design (random effects)
Now create the study design. Then assign the random factors from the study design. 
```{r}
studyDesign = data.frame(sample = as.factor(1:nrow(S)), habitat = as.factor(S$Habitat)) 
rL = HmscRandomLevel(units = studyDesign$sample) 
rL2 = HmscRandomLevel(units = studyDesign$habitat)
```
### Presence-absence data 
The taxa data is zero-inflated and comprised of many rare occurrences. Additionally, there are the stations within the habitats have no replicates. Therefore, a more conservative model will be used: presence-absence using the probit link function. Since the abundance / biomass data are the same taxa recorded differently but the abundance data set has been recorded over more years than the biomass, then the abundance data set will be used. Henceforth, here is the code to convert the taxa abundance data frame into presence-absence data: 
```{r}
Ypa <- 1*(Y>0)
```

### Defining the model
```{r}
m1 <- Hmsc(Y=Ypa, XData = X, XFormula = XFormula,
           TrData = Tr, TrFormula = TrFormula,
           phyloTree = P,
           studyDesign = studyDesign,
           ranLevels = {list("sample" = rL, "habitat" = rL2)}, 
           distr = "probit")
```

Reassign into syntax 
(NB: This is a good way for when running multiple models)
```{r}
models <- list(m1)
modelnames <- "presence_absence"
```

### Set MCMC parameters and run model
```{r}
samples_list = 250
thin_list = 1000
nChains = 4
for(Lst in 1:length(samples_list)){
  thin = thin_list[Lst]
  samples = samples_list[Lst]
  
  print(paste0("thin = ", as.character(thin),"; samples = ", as.character(samples)))
  nm = length(models)
  
  for(model in 1:nm) {
    #model = 1
    print(paste0("model = ",modelnames[model]))
    m = models[[model]]
    m = sampleMcmc(m, samples = samples, thin = thin, 
                   adaptNf=rep(ceiling(0.4*samples*thin),m$nr),
                   transient = ceiling(0.5*samples*thin), 
                   nChains = nChains, nParallel = nChains)
    models[[model]] = m
  }
  filename = paste("models/models_thin_", as.character(thin),
                   "_samples_", as.character(samples),
                   "_chains_",as.character(nChains),
                   ".Rdata",sep = "")
  save(models,modelnames,file=filename)
}
```

### Check model
```{r}
#Call model 
model <- models[[j]]
model$studyDesign
model$ranLevelsUsed
model$TrFormula
model$XFormula
model$samples
model$thin
model$transient
model$call
model$XData
```




